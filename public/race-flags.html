<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Race Flags - Public Display</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
      color: #fff;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
    }

    /* Fullscreen button */
    .fullscreen-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(45deg, #34495e, #2c3e50);
      border: none;
      color: #fff;
      padding: 15px 30px;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 4px 15px rgba(52, 73, 94, 0.4);
      transition: all 0.3s ease;
    }

    .fullscreen-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(52, 73, 94, 0.6);
    }

    /* Main flag display */
    .flag-container {
      text-align: center;
      width: 90%;
      max-width: 1200px;
    }

    .flag-display {
      width: 100%;
      height: 60vh;
      border-radius: 30px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      border: 5px solid #fff;
      margin-bottom: 2rem;
      transition: all 0.5s ease;
    }

    /* Flag backgrounds */
    .flag-green {
      background: linear-gradient(135deg, #27ae60, #2ecc71);
      animation: greenWave 3s ease-in-out infinite;
    }

    .flag-yellow {
      background: linear-gradient(135deg, #f39c12, #f1c40f);
      animation: yellowFlash 1.5s ease-in-out infinite;
    }

    .flag-red {
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      animation: redPulse 1s ease-in-out infinite;
    }

    .flag-checkered {
      background: repeating-linear-gradient(
              45deg,
              #000 0px,
              #000 60px,
              #fff 60px,
              #fff 120px
      );
      animation: checkeredMove 2s linear infinite;
    }

    /* Flag icon */
    .flag-icon {
      font-size: clamp(8rem, 20vw, 20rem);
      margin-bottom: 2rem;
      filter: drop-shadow(0 10px 20px rgba(0, 0, 0, 0.5));
      animation: iconFloat 3s ease-in-out infinite;
    }

    /* Flag text */
    .flag-text {
      font-size: clamp(4rem, 10vw, 10rem);
      font-weight: bold;
      text-shadow:
              0 0 20px rgba(0, 0, 0, 0.8),
              0 5px 10px rgba(0, 0, 0, 0.5);
      margin-bottom: 1rem;
      letter-spacing: 0.1em;
    }

    .flag-description {
      font-size: clamp(2rem, 5vw, 4rem);
      font-weight: 600;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
      opacity: 0.9;
    }

    /* Race info bar */
    .race-info-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 0, 0, 0.7);
      padding: 1.5rem 3rem;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      width: 100%;
      font-size: clamp(1.2rem, 2.5vw, 2rem);
    }

    .info-item {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .info-label {
      color: #bdc3c7;
      font-weight: 600;
    }

    .info-value {
      color: #fff;
      font-weight: bold;
    }

    /* Special text colors for checkered flag */
    .flag-checkered .flag-text,
    .flag-checkered .flag-description {
      color: #000;
      text-shadow:
              0 0 10px #fff,
              0 2px 4px rgba(255, 255, 255, 0.8);
    }

    /* Animations */
    @keyframes greenWave {
      0%, 100% { transform: scale(1); filter: brightness(1); }
      50% { transform: scale(1.02); filter: brightness(1.1); }
    }

    @keyframes yellowFlash {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.3); }
    }

    @keyframes redPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 25px 80px rgba(231, 76, 60, 0.6);
      }
    }

    @keyframes checkeredMove {
      0% { background-position: 0 0; }
      100% { background-position: 120px 120px; }
    }

    @keyframes iconFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-10px); }
    }

    /* Urgent states */
    .urgent {
      animation: urgentShake 0.5s ease-in-out infinite;
    }

    @keyframes urgentShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .race-info-bar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem 2rem;
      }

      .flag-display {
        height: 50vh;
        margin-bottom: 1rem;
      }
    }

    /* Fullscreen styles */
    :fullscreen .fullscreen-btn,
    :-webkit-full-screen .fullscreen-btn,
    :-moz-full-screen .fullscreen-btn {
      display: none;
    }
  </style>
</head>
<body>
<button class="fullscreen-btn" onclick="toggleFullscreen()">
  📺 Full Screen
</button>

<div class="flag-container">
  <div class="flag-display flag-green" id="flagDisplay">
    <div class="flag-icon" id="flagIcon">🟢</div>
    <div class="flag-text" id="flagText">GREEN FLAG</div>
    <div class="flag-description" id="flagDescription">RACE CONDITIONS NORMAL</div>
  </div>

  <div class="race-info-bar">
    <div class="info-item">
      <span class="info-label">RACE STATUS:</span>
      <span class="info-value" id="raceStatus">WAITING</span>
    </div>
    <div class="info-item">
      <span class="info-label">TIME:</span>
      <span class="info-value" id="raceTimer">00:00</span>
    </div>
    <div class="info-item">
      <span class="info-label">DRIVERS:</span>
      <span class="info-value" id="driverCount">0</span>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  class RaceFlagsDisplay {
    constructor() {
      this.socket = io();
      this.currentState = null;
      this.raceTimerInterval = null;

      this.initializeElements();
      this.setupSocketListeners();

      // Flag configurations
      this.flagConfig = {
        'green': {
          icon: '🟢',
          text: 'GREEN FLAG',
          description: 'RACE CONDITIONS NORMAL',
          class: 'flag-green'
        },
        'yellow': {
          icon: '🟡',
          text: 'YELLOW FLAG',
          description: 'CAUTION - SLOW DOWN',
          class: 'flag-yellow'
        },
        'red': {
          icon: '🔴',
          text: 'RED FLAG',
          description: 'STOP IMMEDIATELY',
          class: 'flag-red'
        },
        'checkered': {
          icon: '🏁',
          text: 'CHECKERED FLAG',
          description: 'RACE FINISHED',
          class: 'flag-checkered'
        }
      };
    }

    initializeElements() {
      this.flagDisplay = document.getElementById('flagDisplay');
      this.flagIcon = document.getElementById('flagIcon');
      this.flagText = document.getElementById('flagText');
      this.flagDescription = document.getElementById('flagDescription');
      this.raceStatus = document.getElementById('raceStatus');
      this.raceTimer = document.getElementById('raceTimer');
      this.driverCount = document.getElementById('driverCount');
    }

    setupSocketListeners() {
      this.socket.on('connect', () => {
        console.log('Connected to race server');
      });

      this.socket.on('state_update', (state) => {
        this.currentState = state;
        this.updateDisplay(state);
      });
    }

    updateDisplay(state) {
      this.updateFlag(state.flag);
      this.updateRaceInfo(state);
      this.updateTimer(state);
    }

    updateFlag(flagType) {
      const config = this.flagConfig[flagType] || this.flagConfig['green'];

      // Update flag display
      this.flagDisplay.className = `flag-display ${config.class}`;
      this.flagIcon.textContent = config.icon;
      this.flagText.textContent = config.text;
      this.flagDescription.textContent = config.description;

      // Add urgent animation for red flag
      if (flagType === 'red') {
        this.flagDisplay.classList.add('urgent');
      } else {
        this.flagDisplay.classList.remove('urgent');
      }

      // Play sound effect (if supported)
      this.playFlagSound(flagType);
    }

    updateRaceInfo(state) {
      // Update race status
      const statusTexts = {
        'idle': 'WAITING',
        'countdown': 'STARTING',
        'racing': 'RACING',
        'finished': 'FINISHED'
      };

      this.raceStatus.textContent = statusTexts[state.raceMode] || 'UNKNOWN';

      // Update driver count
      const driverCount = state.currentRace?.drivers?.length || 0;
      this.driverCount.textContent = driverCount;
    }

    updateTimer(state) {
      if (state.raceMode === 'racing' && state.currentRace?.startTime) {
        if (!this.raceTimerInterval) {
          this.startTimer(state.currentRace.startTime);
        }
      } else {
        this.stopTimer();
        this.raceTimer.textContent = '00:00';
      }
    }

    startTimer(startTime) {
      this.raceTimerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const minutes = Math.floor(elapsed / 60000);
        const seconds = Math.floor((elapsed % 60000) / 1000);
        this.raceTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      }, 1000);
    }

    stopTimer() {
      if (this.raceTimerInterval) {
        clearInterval(this.raceTimerInterval);
        this.raceTimerInterval = null;
      }
    }

    playFlagSound(flagType) {
      // Basic sound feedback using Web Audio API
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // Different tones for different flags
        const frequencies = {
          'green': 440,   // A note
          'yellow': 523,  // C note
          'red': 330,     // E note
          'checkered': 659 // E note (higher)
        };

        oscillator.frequency.setValueAtTime(frequencies[flagType] || 440, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (error) {
        // Sound not supported or blocked
        console.log('Audio not available');
      }
    }
  }

  // Fullscreen functionality
  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(err => {
        console.log(`Error attempting to enable fullscreen: ${err.message}`);
      });
    } else {
      document.exitFullscreen();
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new RaceFlagsDisplay();
  });
</script>
</body>
</html>