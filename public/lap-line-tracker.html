<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lap Line Tracker</title>
  <style>
    /* Base styles with proper padding */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #1a2a3a, #0d1b2a);
      color: #e0e0e0;
      min-height: 100vh;
      box-sizing: border-box;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 900px;
      margin: 0 auto;
      padding: 0 15px;
      box-sizing: border-box;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: rgba(30, 40, 50, 0.8);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      margin-bottom: 20px;
    }

    .header h1 {
      margin: 0;
      font-size: 2rem;
      color: #f5f5f5;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Logout button */
    #logoutBtn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 15px;
      border-radius: 8px;
      border: none;
      background: rgba(44, 62, 80, 0.8);
      color: #ecf0f1;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 3px 5px rgba(0,0,0,0.2);
      font-size: 0.9rem;
    }

    #logoutBtn:hover {
      background: rgba(52, 73, 94, 0.9);
      transform: translateY(-2px);
    }

    .session-info {
      padding: 15px;
      border: 1px solid #2c3e50;
      border-radius: 8px;
      background: rgba(30, 40, 50, 0.7);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      margin-bottom: 20px;
    }

    .connection-status {
      padding: 8px;
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .connected {
      background-color: #27ae60;
      color: white;
    }

    .disconnected {
      background-color: #c0392b;
      color: white;
      animation: pulse 1.5s infinite;
    }

    /* Button styles */
    .car-buttons-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 15px;
      flex: 1;
      padding: 20px;
      box-sizing: border-box;
    }

    .car-button {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 15px 10px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: rgba(40, 55, 70, 0.8);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      color: #ecf0f1;
      min-height: 140px;
      position: relative;
      overflow: hidden;
    }

    .car-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
      background: rgba(50, 65, 80, 0.9);
    }

    .car-button:active {
      transform: translateY(1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .car-button .car-icon {
      font-size: 3rem;
      margin-bottom: 10px;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }

    .car-button .car-number {
      font-size: 2.2em;
      font-weight: bold;
      margin-bottom: 5px;
      color: #3498db;
    }

    .car-button .lap-count {
      font-size: 0.9em;
      opacity: 0.8;
    }

    .car-button .driver-name {
      font-size: 0.8em;
      opacity: 0.7;
      margin-top: 5px;
      text-align: center;
    }

    .status-bar {
      padding: 15px;
      background: rgba(30, 40, 50, 0.9);
      color: white;
      text-align: center;
      border-bottom: 1px solid #2c3e50;
      border-top: 1px solid #2c3e50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 0 -15px 20px;
      padding: 15px;
      border-radius: 8px;
    }

    .session-ended {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 300px;
      font-size: 1.8em;
      text-align: center;
      padding: 30px;
      background: rgba(30, 40, 50, 0.7);
      border-radius: 10px;
      margin: 20px 0;
    }

    .session-ended .end-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }

    /* Status indicators */
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-idle { background-color: #7f8c8d; }
    .status-countdown { background-color: #f39c12; }
    .status-racing { background-color: #2ecc71; }
    .status-finished { background-color: #e74c3c; }

    /* Flag indicators */
    .flag-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px;
      border-radius: 4px;
      background: rgba(44, 62, 80, 0.8);
    }

    .flag-green { border-left: 4px solid #2ecc71; }
    .flag-yellow { border-left: 4px solid #f1c40f; }
    .flag-red { border-left: 4px solid #e74c3c; }
    .flag-checkered {
      border-left: 4px solid transparent;
      background: repeating-linear-gradient(45deg, rgba(0,0,0,0.3), rgba(0,0,0,0.3) 5px, rgba(255,255,255,0.3) 5px, rgba(255,255,255,0.3) 10px);
    }

    /* Animations */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .active-car {
      box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.7), 0 0 15px rgba(46, 204, 113, 0.5);
      animation: pulseActive 1.5s infinite;
    }

    @keyframes pulseActive {
      0% { box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.7), 0 0 15px rgba(46, 204, 113, 0.5); }
      50% { box-shadow: 0 0 0 5px rgba(46, 204, 113, 0.5), 0 0 20px rgba(46, 204, 113, 0.7); }
      100% { box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.7), 0 0 15px rgba(46, 204, 113, 0.5); }
    }

    .lap-recorded {
      background: linear-gradient(135deg, #27ae60, #2ecc71) !important;
      transform: scale(1.05);
    }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 300px;
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
    }

    .empty-state .empty-icon {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.5;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .car-buttons-grid {
        grid-template-columns: repeat(3, 1fr);
        padding: 10px;
      }

      .status-bar {
        flex-direction: column;
        gap: 10px;
      }
    }

    @media (max-width: 480px) {
      .car-buttons-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .header h1 {
        font-size: 1.5rem;
      }
    }

    /* Racing state effects */
    .racing-active .car-buttons-grid {
      animation: racingGlow 3s infinite;
    }

    @keyframes racingGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.1); }
    }
  </style>
</head>
<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <h1>
      <span>üèÅ</span>
      Lap Line Tracker
    </h1>
    <button id="logoutBtn">
      <span>üö™</span>
      Logout
    </button>
  </div>

  <div id="connectionStatus" class="connection-status disconnected">Disconnected</div>

  <div class="session-info">
    <h2>Current Session</h2>
    <div id="currentSession">
      <p>No active session</p>
    </div>
  </div>

  <div class="status-bar">
    <div id="raceStatus">No active race</div>
    <div id="modeIndicator" class="flag-indicator flag-green">
      <span>üü¢</span>
      <span>SAFE</span>
    </div>
  </div>

  <div id="trackerInterface">
    <div id="carButtons" class="car-buttons-grid"></div>
    <div id="sessionEnded" class="session-ended" style="display: none;">
      <div class="end-icon">üèÅ</div>
      <p>Race session has ended</p>
    </div>
    <div id="emptyState" class="empty-state">
      <div class="empty-icon">üèéÔ∏è</div>
      <p>Waiting for active race...</p>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
  class LapLineTracker {
    constructor() {
      this.socket = io({
        reconnection: true,
        reconnectionAttempts: Infinity,
        reconnectionDelay: 1000,
        reconnectionDelayMax: 5000,
        randomizationFactor: 0.5,
        transports: ['websocket']
      });

      this.currentState = null;
      this.raceStartTime = null;
      this.timerInterval = null;

      this.initializeElements();
      this.setupEventListeners();
      this.setupSocketListeners();

      // Since we're already authenticated (redirected here), start immediately
      this.updateConnectionStatus(false);
      this.logToConsole('Lap Line Tracker initialized - authenticated user', 'success');
    }

    initializeElements() {
      this.carButtonsEl = document.getElementById('carButtons');
      this.sessionEndedEl = document.getElementById('sessionEnded');
      this.emptyStateEl = document.getElementById('emptyState');
      this.raceStatusEl = document.getElementById('raceStatus');
      this.connectionStatusEl = document.getElementById('connectionStatus');
      this.currentSessionEl = document.getElementById('currentSession');
      this.modeIndicator = document.getElementById('modeIndicator');
      this.logoutBtn = document.getElementById('logoutBtn');
      this.trackerInterface = document.getElementById('trackerInterface');
    }

    setupEventListeners() {
      // Logout button
      this.logoutBtn.addEventListener('click', async () => {
        try {
          await fetch('/logout', { method: 'POST' });
          window.location.href = '/';
        } catch (error) {
          this.logToConsole(`Logout error: ${error.message}`, 'error');
          window.location.href = '/'; // Fallback
        }
      });
    }

    setupSocketListeners() {
      this.socket.on('connect', () => {
        this.logToConsole('Connected to race server', 'success');
        this.updateConnectionStatus(true);
      });

      this.socket.on('disconnect', (reason) => {
        this.logToConsole(`Disconnected: ${reason}`, 'error');
        this.updateConnectionStatus(false);
      });

      this.socket.on('state_update', (state) => {
        this.currentState = state;
        this.updateUI(state);
      });

      this.socket.on('lap_update', (lapData) => {
        this.handleLapUpdate(lapData);
      });

      this.socket.on('error_message', (message) => {
        this.logToConsole(`Server error: ${message}`, 'error');
      });
    }

    updateUI(state) {
      this.logToConsole('Received state update in lap tracker');

      // Update race status and mode indicator
      this.updateRaceStatus(state);
      this.updateModeIndicator(state);
      this.updateSessionInfo(state);

      // Show appropriate interface
      if (state.currentRace && state.raceMode === 'racing') {
        this.showCarButtons(state.currentRace);
        this.trackerInterface.classList.add('racing-active');
      } else if (state.raceMode === 'finished') {
        this.showSessionEnded();
        this.trackerInterface.classList.remove('racing-active');
      } else {
        this.showEmptyState();
        this.trackerInterface.classList.remove('racing-active');
      }
    }

    updateRaceStatus(state) {
      if (state.currentRace && state.raceMode === 'racing') {
        if (state.currentRace.startTime) {
          this.raceStartTime = state.currentRace.startTime;
          this.startRaceTimer();
        }
      } else {
        this.stopRaceTimer();
        const statusTexts = {
          'idle': 'No active race',
          'countdown': 'Race starting soon...',
          'finished': 'Race finished'
        };
        this.raceStatusEl.textContent = statusTexts[state.raceMode] || 'Unknown status';
      }
    }

    updateModeIndicator(state) {
      const flagConfig = {
        'green': { icon: 'üü¢', text: 'SAFE', class: 'flag-green' },
        'yellow': { icon: 'üü°', text: 'CAUTION', class: 'flag-yellow' },
        'red': { icon: 'üî¥', text: 'DANGER', class: 'flag-red' },
        'checkered': { icon: 'üèÅ', text: 'FINISH', class: 'flag-checkered' }
      };

      const config = flagConfig[state.flag] || flagConfig['green'];
      this.modeIndicator.className = `flag-indicator ${config.class}`;
      this.modeIndicator.innerHTML = `<span>${config.icon}</span><span>${config.text}</span>`;
    }

    updateSessionInfo(state) {
      if (state.currentRace) {
        let sessionHTML = `
          <p><strong>Race:</strong> ${state.currentRace.name || state.currentRace.id}</p>
          <p><strong>Status:</strong> ${state.raceMode.toUpperCase()}</p>
        `;

        if (state.currentRace.drivers && state.currentRace.drivers.length > 0) {
          sessionHTML += '<p><strong>Drivers:</strong></p><ul>';
          state.currentRace.drivers.forEach(driver => {
            const lapCount = state.currentRace.laps && state.currentRace.laps[driver.name]
                    ? state.currentRace.laps[driver.name].length
                    : 0;
            sessionHTML += `<li>${driver.name} (${driver.car || 'No car'}) - ${lapCount} laps</li>`;
          });
          sessionHTML += '</ul>';
        }

        this.currentSessionEl.innerHTML = sessionHTML;
      } else {
        this.currentSessionEl.innerHTML = '<p>No active session</p>';
      }
    }

    showCarButtons(race) {
      this.carButtonsEl.style.display = 'grid';
      this.sessionEndedEl.style.display = 'none';
      this.emptyStateEl.style.display = 'none';

      // Clear existing buttons
      this.carButtonsEl.innerHTML = '';

      if (!race.drivers || race.drivers.length === 0) {
        this.showEmptyState();
        return;
      }

      // Create buttons for each driver
      race.drivers.forEach(driver => {
        const button = document.createElement('button');
        button.className = 'car-button';
        button.dataset.driverName = driver.name;

        // Car icon
        const carIcon = document.createElement('div');
        carIcon.className = 'car-icon';
        carIcon.textContent = 'üèéÔ∏è';

        // Car/Driver info
        const carNumber = document.createElement('div');
        carNumber.className = 'car-number';
        carNumber.textContent = driver.car || 'N/A';

        // Driver name
        const driverName = document.createElement('div');
        driverName.className = 'driver-name';
        driverName.textContent = driver.name;

        // Lap count
        const lapCount = document.createElement('div');
        lapCount.className = 'lap-count';
        const currentLaps = race.laps && race.laps[driver.name] ? race.laps[driver.name].length : 0;
        lapCount.textContent = `Laps: ${currentLaps}`;

        // Add click handler
        button.addEventListener('click', () => {
          this.recordLap(driver.name, button);
        });

        // Assemble button
        button.appendChild(carIcon);
        button.appendChild(carNumber);
        button.appendChild(driverName);
        button.appendChild(lapCount);

        this.carButtonsEl.appendChild(button);
      });
    }

    showSessionEnded() {
      this.carButtonsEl.style.display = 'none';
      this.sessionEndedEl.style.display = 'flex';
      this.emptyStateEl.style.display = 'none';
    }

    showEmptyState() {
      this.carButtonsEl.style.display = 'none';
      this.sessionEndedEl.style.display = 'none';
      this.emptyStateEl.style.display = 'flex';
    }

    recordLap(driverName, buttonElement) {
      // Generate a realistic lap time (between 45-75 seconds in milliseconds)
      const lapTime = Math.floor(Math.random() * (75000 - 45000) + 45000);

      this.logToConsole(`Recording lap for ${driverName}: ${this.formatTime(lapTime)}`);

      // Send to server
      this.socket.emit('record_lap', {
        driverName: driverName,
        lapTime: lapTime
      });

      // Visual feedback
      buttonElement.classList.add('active-car');
      setTimeout(() => {
        buttonElement.classList.remove('active-car');
        buttonElement.classList.add('lap-recorded');
        setTimeout(() => {
          buttonElement.classList.remove('lap-recorded');
        }, 1000);
      }, 300);

      // Update lap count immediately for better UX
      const lapCountEl = buttonElement.querySelector('.lap-count');
      const currentText = lapCountEl.textContent;
      const currentCount = parseInt(currentText.match(/\d+/)[0]);
      lapCountEl.textContent = `Laps: ${currentCount + 1}`;
    }

    handleLapUpdate(lapData) {
      this.logToConsole(`Lap recorded: ${lapData.driverName} - ${this.formatTime(lapData.lapTime)}`);

      // Update the corresponding button
      const button = this.carButtonsEl.querySelector(`[data-driver-name="${lapData.driverName}"]`);
      if (button) {
        const lapCountEl = button.querySelector('.lap-count');
        lapCountEl.textContent = `Laps: ${lapData.lapNumber || 'N/A'}`;
      }
    }

    startRaceTimer() {
      if (this.timerInterval) clearInterval(this.timerInterval);

      this.timerInterval = setInterval(() => {
        if (this.raceStartTime) {
          const elapsed = Math.floor((Date.now() - this.raceStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          this.raceStatusEl.textContent = `Active Race | Elapsed: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
      }, 1000);
    }

    stopRaceTimer() {
      if (this.timerInterval) {
        clearInterval(this.timerInterval);
        this.timerInterval = null;
      }
    }

    formatTime(milliseconds) {
      if (!milliseconds || milliseconds <= 0) return '-';

      const totalSeconds = milliseconds / 1000;
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;

      if (minutes > 0) {
        return `${minutes}:${seconds.toFixed(3).padStart(6, '0')}`;
      } else {
        return `${seconds.toFixed(3)}s`;
      }
    }

    updateConnectionStatus(connected) {
      if (connected) {
        this.connectionStatusEl.textContent = 'Connected to Race Server';
        this.connectionStatusEl.className = 'connection-status connected';
      } else {
        this.connectionStatusEl.textContent = 'Disconnected from Server';
        this.connectionStatusEl.className = 'connection-status disconnected';
      }
    }

    logToConsole(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] ${message}`);
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener('DOMContentLoaded', () => {
    new LapLineTracker();
  });
</script>
</body>
</html>